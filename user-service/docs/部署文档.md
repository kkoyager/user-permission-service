# 用户服务部署文档

## 环境要求

### 基础环境
- **JDK**: 11+
- **Maven**: 3.6+
- **MySQL**: 8.0+
- **Nacos**: 2.3.2
- **RocketMQ**: 5.3.3
- **Seata**: 1.8.0

### 中间件安装

#### 1. MySQL数据库准备
```sql
-- 创建数据库
CREATE DATABASE user_db_0 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE DATABASE user_db_1 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户表（在每个数据库中执行）
USE user_db_0;
CREATE TABLE users (
  user_id BIGINT PRIMARY KEY COMMENT '用户ID，使用雪花算法生成',
  username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
  password VARCHAR(255) NOT NULL COMMENT '密码',
  email VARCHAR(100) COMMENT '邮箱',
  phone VARCHAR(20) COMMENT '手机号',
  gmt_create TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  gmt_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  INDEX idx_username (username),
  INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表-分片0';

USE user_db_1;
-- 同样的表结构
```

#### 2. Nacos启动
```bash
# Windows
startup.cmd -m standalone

# Linux
sh startup.sh -m standalone
```

访问: http://localhost:8848/nacos
默认账号密码: nacos/nacos

#### 3. RocketMQ启动
```bash
# 启动NameServer
sh mqnamesrv

# 启动Broker
sh mqbroker -n localhost:9876 autoCreateTopicEnable=true
```

#### 4. Seata启动
```bash
# 修改conf/registry.conf配置Nacos注册中心
# 启动Seata Server
sh seata-server.sh -p 8091 -m file
```

## 项目部署

### 1. 编译打包
```bash
cd user-service
mvn clean package -DskipTests
```

### 2. 配置文件修改
修改 `src/main/resources/application.yml` 中的配置：

```yaml
spring:
  shardingsphere:
    datasource:
      ds0:
        jdbc-url: jdbc:mysql://你的数据库地址:3306/user_db_0?useUnicode=true&characterEncoding=utf8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai
        username: 你的数据库用户名
        password: 你的数据库密码
      ds1:
        jdbc-url: jdbc:mysql://你的数据库地址:3306/user_db_1?useUnicode=true&characterEncoding=utf8&allowMultiQueries=true&useSSL=false&serverTimezone=Asia/Shanghai
        username: 你的数据库用户名
        password: 你的数据库密码
  
  cloud:
    nacos:
      discovery:
        server-addr: 你的Nacos地址:8848

rocketmq:
  name-server: 你的RocketMQ地址:9876

seata:
  registry:
    nacos:
      server-addr: 你的Nacos地址:8848
```

### 3. 启动应用
```bash
# 方式1: 直接运行jar包
java -jar target/user-service-1.0.0.jar

# 方式2: Maven启动
mvn spring-boot:run

# 方式3: IDE启动
运行 UserServiceApplication.main() 方法
```

### 4. 验证部署
```bash
# 健康检查
curl http://localhost:8080/user/health

# 预期响应
{
  "code": 200,
  "message": "操作成功",
  "data": "用户服务运行正常"
}
```

## Docker部署（可选）

### 1. 创建Dockerfile
```dockerfile
FROM openjdk:11-jre-slim

WORKDIR /app

COPY target/user-service-1.0.0.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 2. 构建镜像
```bash
docker build -t user-service:1.0.0 .
```

### 3. 运行容器
```bash
docker run -d \
  --name user-service \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  user-service:1.0.0
```

## 监控配置

### 1. 日志配置
应用日志位置: `logs/user-service.log`

关键日志监控：
- 用户注册/登录操作
- 数据库连接异常
- RPC调用失败
- MQ消息发送失败

### 2. JVM监控
```bash
# JVM参数建议
-Xms512m -Xmx1024m
-XX:+UseG1GC
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
```

### 3. 健康检查
```bash
# 定期检查服务状态
curl http://localhost:8080/user/health
```

## 问题排查

### 常见问题

1. **数据库连接失败**
   - 检查数据库配置和网络连通性
   - 确认数据库用户权限

2. **Nacos注册失败**
   - 检查Nacos服务是否启动
   - 确认网络和端口配置

3. **RocketMQ连接失败**
   - 检查RocketMQ NameServer是否启动
   - 确认topic是否已创建

4. **分库分表路由异常**
   - 检查ShardingSphere配置
   - 查看SQL执行日志

### 日志关键字
- `ERROR`: 系统错误，需要立即处理
- `WARN`: 警告信息，需要关注
- `分库分表`: 数据路由相关
- `RPC调用`: 服务间调用相关
- `MQ消息`: 消息队列相关

## 扩容建议

1. **数据库扩容**: 增加分片数量，修改分片规则
2. **应用扩容**: 部署多个实例，通过负载均衡分发流量
3. **缓存优化**: 添加Redis缓存热点数据
4. **读写分离**: 配置MySQL主从复制，分离读写操作
